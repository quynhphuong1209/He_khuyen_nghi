# -*- coding: utf-8 -*-
"""Quá»³nh PhÆ°Æ¡ng 3_1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/10oZPNIyrHZfNShMn3ngLNo0QWstBtCmn

# =============================
# BÃ€I Táº¬P 1: MÃ´ hÃ¬nh cÃ¢y quyáº¿t Ä‘á»‹nh cho há»‡ khuyáº¿n nghá»‹
# =============================
"""

import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.tree import DecisionTreeClassifier, plot_tree
from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score
from sklearn.metrics import confusion_matrix, roc_curve, auc
import matplotlib.pyplot as plt
import seaborn as sns
import os
import urllib.request
import zipfile

ml_100k_url = 'https://files.grouplens.org/datasets/movielens/ml-100k.zip'
ml_100k_zip = 'ml-100k.zip'
ml_100k_folder = 'ml-100k'

if not os.path.exists(ml_100k_folder):
    if not os.path.exists(ml_100k_zip):
        print('Downloading MovieLens 100K dataset...')
        urllib.request.urlretrieve(ml_100k_url, ml_100k_zip)
    print('Extracting MovieLens 100K dataset...')
    with zipfile.ZipFile(ml_100k_zip, 'r') as zip_ref:
        zip_ref.extractall('.')

# Äá»c dá»¯ liá»‡u Ä‘Ã¡nh giÃ¡
ratings_cols = ['userID', 'itemID', 'rating', 'timestamp']
ratings_df = pd.read_csv('ml-100k/u.data', sep='\t', names=ratings_cols, encoding='latin-1')

# Äá»c thÃ´ng tin ngÆ°á»i dÃ¹ng
users_cols = ['user_id', 'age', 'gender', 'occupation', 'zip_code']
users = pd.read_csv('ml-100k/u.user', sep='|', names=users_cols, encoding='latin-1')

# Äá»c thÃ´ng tin phim
movies_cols = ['movie_id', 'title', 'release_date', 'video_release_date',
               'imdb_url', 'unknown', 'Action', 'Adventure', 'Animation',
               'Children', 'Comedy', 'Crime', 'Documentary', 'Drama', 'Fantasy',
               'Film-Noir', 'Horror', 'Musical', 'Mystery', 'Romance', 'Sci-Fi',
               'Thriller', 'War', 'Western']
movies = pd.read_csv('ml-100k/u.item', sep='|', names=movies_cols, encoding='latin-1')

ratings_df.head()

users[users["user_id"] == 186]

movies[movies["movie_id"] == 243]

len(users.occupation.unique())

from google.colab import sheets
sheet = sheets.InteractiveSheet(df=ratings_df)

# TODO: Tiá»n xá»­ lÃ½ dá»¯ liá»‡u
# 1. Chuyá»ƒn Ä‘á»•i Ä‘áº·c trÆ°ng phÃ¢n loáº¡i (gender, occupation) thÃ nh one-hot encoding
users_processed = users.copy()
users_processed = pd.get_dummies(users_processed, columns=['gender', 'occupation'])
users_processed[users_processed["user_id"] == 186]

# TODO: Táº¡o biáº¿n má»¥c tiÃªu (thÃ­ch/khÃ´ng thÃ­ch)
# Táº¡o biáº¿n ratings_merged báº±ng cÃ¡ch ná»‘i cÃ¡c báº£ng
ratings_merged = pd.merge(ratings_df, users, left_on='userID', right_on='user_id')
ratings_merged = pd.merge(ratings_merged, movies, left_on='itemID', right_on='movie_id')

# Táº¡o cá»™t má»¥c tiÃªu 'liked' dá»±a trÃªn rating
if 'rating' in ratings_merged.columns:
    ratings_merged['liked'] = (ratings_merged['rating'] >= 4).astype(int)
else:
    raise KeyError("âš ï¸ KhÃ´ng tÃ¬m tháº¥y cá»™t 'rating' trong ratings_merged Ä‘á»ƒ táº¡o cá»™t 'liked'.")

# Kiá»ƒm tra
print("âœ… Táº¡o xong cá»™t 'liked'. CÃ¡c cá»™t hiá»‡n cÃ³:", ratings_merged.columns.tolist())
print("ğŸ“Š Xem dá»¯ liá»‡u:")
print(ratings_merged[['userID', 'itemID', 'rating', 'liked']].head())

# TODO: Chia dá»¯ liá»‡u thÃ nh táº­p huáº¥n luyá»‡n vÃ  táº­p kiá»ƒm tra
# One-hot encoding cho cÃ¡c cá»™t phÃ¢n loáº¡i trong users
users_encoded = pd.get_dummies(users[['user_id', 'age', 'gender', 'occupation']], columns=['gender', 'occupation'])

# Káº¿t há»£p users_encoded vÃ o ratings_merged
ratings_merged = pd.merge(ratings_df, users_encoded, left_on='userID', right_on='user_id')
ratings_merged = pd.merge(ratings_merged, movies, left_on='itemID', right_on='movie_id')

# Táº¡o biáº¿n má»¥c tiÃªu
ratings_merged['liked'] = (ratings_merged['rating'] >= 4).astype(int)

# Táº¡o biáº¿n má»¥c tiÃªu
ratings_merged['liked'] = (ratings_merged['rating'] >= 4).astype(int)

# XÃ¢y dá»±ng danh sÃ¡ch cÃ¡c biáº¿n Ä‘áº§u vÃ o
feature_cols = ['age'] + list(users_encoded.columns.drop(['user_id'])) + [
    'unknown', 'Action', 'Adventure', 'Animation', 'Children', 'Comedy', 'Crime', 'Documentary',
    'Drama', 'Fantasy', 'Film-Noir', 'Horror', 'Musical', 'Mystery', 'Romance', 'Sci-Fi',
    'Thriller', 'War', 'Western'
]

# Kiá»ƒm tra xem cÃ¡c cá»™t cÃ³ Ä‘á»§ khÃ´ng
for col in feature_cols:
    if col not in ratings_merged.columns:
        raise KeyError(f"âš ï¸ Thiáº¿u cá»™t '{col}' trong ratings_merged. Kiá»ƒm tra láº¡i viá»‡c merge hoáº·c xá»­ lÃ½ dá»¯ liá»‡u.")

# TÃ¡ch dá»¯ liá»‡u
X = ratings_merged[feature_cols]
y = ratings_merged['liked']

from sklearn.model_selection import train_test_split
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

print("ğŸ“‹ Xem báº£ng ratings_merged (sau khi merge vÃ  thÃªm 'liked'):")
display(ratings_merged.head())

print("ğŸ§¾ CÃ¡c Ä‘áº·c trÆ°ng (X):")
display(X.head())

print("âœ… NhÃ£n má»¥c tiÃªu (y):")
display(y.head())

print("ğŸ”¹ X_train:")
display(X_train.head())

print("ğŸ”¸ y_train:")
display(y_train.head())

# TODO: XÃ¢y dá»±ng vÃ  huáº¥n luyá»‡n mÃ´ hÃ¬nh cÃ¢y quyáº¿t Ä‘á»‹nh
clf = DecisionTreeClassifier(max_depth=5, random_state=42)
clf.fit(X_train, y_train)

# TODO: ÄÃ¡nh giÃ¡ hiá»‡u suáº¥t mÃ´ hÃ¬nh
y_pred = clf.predict(X_test)
print("Accuracy:", accuracy_score(y_test, y_pred))
print("Precision:", precision_score(y_test, y_pred))
print("Recall:", recall_score(y_test, y_pred))
print("F1 Score:", f1_score(y_test, y_pred))

# Ma tráº­n nháº§m láº«n
cm = confusion_matrix(y_test, y_pred)
sns.heatmap(cm, annot=True, fmt='d', cmap='Blues')
plt.title('Confusion Matrix')
plt.xlabel('Predicted')
plt.ylabel('Actual')
plt.show()

# ROC Curve
y_prob = clf.predict_proba(X_test)[:, 1]
fpr, tpr, thresholds = roc_curve(y_test, y_prob)
roc_auc = auc(fpr, tpr)

plt.plot(fpr, tpr, label=f"AUC = {roc_auc:.2f}")
plt.plot([0, 1], [0, 1], 'k--')
plt.xlabel("False Positive Rate")
plt.ylabel("True Positive Rate")
plt.title("ROC Curve")
plt.legend()
plt.show()

# TODO: Trá»±c quan hÃ³a cÃ¢y quyáº¿t Ä‘á»‹nh vÃ  phÃ¢n tÃ­ch Ä‘áº·c trÆ°ng quan trá»ng
plt.figure(figsize=(20, 10))
plot_tree(clf, feature_names=feature_cols, class_names=['Not Liked', 'Liked'], filled=True, rounded=True)
plt.title("Decision Tree")
plt.show()

importances = pd.Series(clf.feature_importances_, index=feature_cols).sort_values(ascending=False)
plt.figure(figsize=(10, 6))
sns.barplot(x=importances.values, y=importances.index)
plt.title("Feature Importances")
plt.xlabel("Importance Score")
plt.show()